# Changelog: P0 Geometry Fixes

**Date:** 2025-01-12
**Session:** P0 Gabled Roof Geometry Correctness
**Version:** 0.2.1 -> 0.2.2

---

## Summary

This session addressed geometry issues with gabled roof generation to ensure:
1. **No gaps** between walls and roof (gable walls connect seamlessly)
2. **Roof visible from below** (underside faces for overhang)
3. **Improved debug logging** for troubleshooting

---

## Problem Description

From user feedback (Wiek Schoenmakers):
- The gable (triangular wall portion) was detached from the front/back wall
- Side walls didn't connect properly to the building/roof
- Roof overhang was transparent when viewed from below (single-sided faces)

### Visual Reference
- **Goal:** Solid house with gable walls flush with rectangular walls, roof visible from all angles
- **Before:** Gaps between gable and walls, transparent overhang from below

---

## Fix 1: Gable Wall Generation (P0.1a)

### Problem
The triangular gable walls were generated as part of the roof, but weren't connecting seamlessly with the rectangular wall portions below.

### Solution
Rewrote `_generate_gable_walls()` function to:
1. Identify gable edges (edges parallel to ridge direction)
2. Generate triangular wall faces from footprint edge corners (at `eave_z`) to ridge point
3. Use correct winding order for outward-facing normals

### Key Change
Changed edge detection from "perpendicular to ridge" (`dot < 0.4`) to "parallel to ridge" (`dot > 0.7`), which correctly identifies the short sides of the building where gable walls are needed.

```python
# OLD (incorrect)
if dot < 0.4:  # Approximately perpendicular (within ~66 degrees)

# NEW (correct)
if dot > 0.7:  # Edge is parallel to ridge (gable end)
```

---

## Fix 2: Roof Underside Faces (P0.2)

### Problem
Roof slopes were single-sided. When viewed from below, the overhang appeared transparent because face normals pointed upward only.

### Solution
Added new function `_generate_roof_underside()` that creates horizontal soffit faces at `eave_z` level:

1. **Side soffits:** Rectangular strips under left and right eaves
2. **Gable soffits:** Triangular areas under front and back gable overhangs

### Geometry
```
Looking from below at the soffit:

     +---------+        Back soffit (triangles)
    /           \
   /             \
  +---------------+
  |               |     Side soffits (quads)
  |   (building   |
  |    interior)  |
  |               |
  +---------------+
   \             /
    \           /      Front soffit (triangles)
     +---------+
```

### Implementation Details
- Soffit faces use **downward-facing normals** (CCW when viewed from below)
- Only generated when `overhang > 0` (LOD0)
- LOD1 has no overhang, so no underside needed

---

## Fix 3: Side Wall Connection (P0.1b)

### Analysis
The rectangular walls (generated by `walls.py`) terminate at `wall_top_z` (eave height). The roof OBB corners are at the same elevation.

For rectangular footprints (4 vertices), the OBB computed by `compute_obb()` matches the footprint exactly, so:
- Wall corners align with OBB corners
- No gaps between walls and roof

This was already working correctly for rectangular buildings. The perceived gaps were from:
1. Missing gable walls (fixed in P0.1a)
2. Missing underside (fixed in P0.2)

---

## Fix 4: Enhanced Debug Logging (P0.3)

### Changes
Improved the debug log output when `DEBUG_GABLED_ROOFS = True`:

```python
# Before
f"GABLED DEBUG [{building.osm_id}]: vertices={vertex_count}, ..."

# After
f"GABLED DEBUG [{building.osm_id}]: verts={vertex_count}, "
f"OBB={obb['length']:.1f}x{obb['width']:.1f}m, "
f"ridge_dir={ridge_direction:.1f}° (src={ridge_source}), "
f"span={obb['width']:.1f}m, "
f"pitch={pitch_deg:.1f}°, "
f"ridge_h={ridge_height:.2f}m, "
f"wall_h={building.height_m:.1f}m, "
f"eave_z={eave_z:.2f}m, "
f"ridge_z={ridge_z:.2f}m, "
f"overhang={config.overhang:.2f}m"
```

Now includes: `eave_z`, `ridge_z`, and `overhang` values for easier debugging.

---

## Files Modified

| File | Changes |
|------|---------|
| `generators/roof_gabled.py` | New `_generate_roof_underside()`, rewritten `_generate_gable_walls()`, enhanced debug logging, updated docstrings |

---

## Test Results (Patch 036019)

### Before This Session
- LOD0: 181,978 vertices, 104,886 faces
- LOD1: 181,978 vertices, 104,886 faces

### After P0 Fixes
- **LOD0: 231,516 vertices, 128,902 faces** (+49,538 vertices, +24,016 faces)
- **LOD1: 193,986 vertices, 108,052 faces** (+12,008 vertices, +3,166 faces)

The increase in LOD0 vertex/face count is due to:
- Underside soffit faces (~37,500 additional vertices for 2085 gabled buildings)
- Some additional vertices from improved gable wall generation

LOD1 increase is smaller (no underside) but includes improved gable walls.

### Statistics
```
Buildings processed: 5416
Gabled roofs: 2085
Flat roofs: 3331

Footprint vertex distribution:
  4 vertices (rectangles): 2529
  5-6 vertices: 1181
  7-8 vertices: 841
  9+ vertices: 865
```

---

## Acceptance Criteria Verification

| Criterion | Status |
|-----------|--------|
| No cracks between wall↔gable | Fixed - gable walls now connect to footprint edges |
| No cracks between wall↔roof | OK - walls terminate at eave_z, roof starts at eave_z |
| Eaves visible from below | Fixed - underside faces added for overhang |
| Debug logging for gabled | Enhanced - shows span, eave_z, ridge_z, overhang |

---

## Configuration

New `GabledRoofConfig` option:
```python
@dataclass
class GabledRoofConfig:
    overhang: float = 0.0
    include_gable_walls: bool = True
    include_roof_underside: bool = True  # NEW
```

Default behavior:
- LOD0: `include_roof_underside=True` (with overhang)
- LOD1: `include_roof_underside=False` (no overhang)

---

## Next Steps

Recommended priorities for future iterations:

1. **UV Mapping** - Assign texture coordinates to walls and roofs
2. **Materials** - Generate MTL file with texture assignments
3. **Height Quantization** - Snap heights to 3m floor modules
4. **Gable Wall Material** - Currently uses roof material, should use wall material
